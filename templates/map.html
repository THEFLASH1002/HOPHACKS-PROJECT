<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Baltimore Crime Heatmap + Traffic</title>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    body, html { margin:0; padding:0; height:100%; }
    #map { position:absolute; top:0; bottom:0; width:100%; }
    .mapboxgl-popup {
      max-width: 300px;
      font: 14px/20px "Helvetica Neue", Arial, Helvetica, sans-serif;
    }
    .controls { 
      position:absolute; 
      left:10px; 
      top:10px; 
      background:white; 
      padding:8px; 
      border-radius:6px; 
      box-shadow:0 2px 6px rgba(0,0,0,0.2);
      z-index: 1;
    }
    .controls button {
      display:block;
      margin-bottom:6px;
    }
  </style>
</head>
<body>

<div id="map"></div>

<div class="controls">
  <button id="toggleCrimeBtn">Toggle Crime Map</button>
  <button id="toggleTrafficBtn">Toggle Traffic</button>
</div>

<script>
mapboxgl.accessToken = "pk.eyJ1IjoidGhlZmxhc2gxMDAyIiwiYSI6ImNtZmYwMjZuODBkN2UybXExaTM2ZGl0d3cifQ.j520k_qlveWfMAYCCu5IqQ"; // replace with your token

const map = new mapboxgl.Map({
  container: "map",
  style: "mapbox://styles/mapbox/streets-v12",
  center: [-76.6122, 39.2904], // Baltimore
  zoom: 11,
  pitch: 45,
  bearing: -17.6
});

map.on("load", () => {
  // Add 3D buildings
  map.addLayer({
    id: "3d-buildings",
    source: "composite",
    "source-layer": "building",
    filter: ["==", "extrude", "true"],
    type: "fill-extrusion",
    minzoom: 15,
    paint: {
      "fill-extrusion-color": "#aaa",
      "fill-extrusion-height": ["get", "height"],
      "fill-extrusion-base": ["get", "min_height"],
      "fill-extrusion-opacity": 0.6
    }
  });

  // Load crime neighborhood data
  fetch("/api/neighborhoods")
    .then(res => res.json())
    .then(data => {
      map.addSource("neighborhoods", { type: "geojson", data });

      // Crime heatmap
      map.addLayer({
        id: "crime-heat",
        type: "fill",
        source: "neighborhoods",
        paint: {
          "fill-color": [
            "interpolate",
            ["linear"], ["get", "crime_count"],
            0, "#2DC937",
            50, "#FFCC00",
            200, "#D7263D"
          ],
          "fill-opacity": 0.6
        }
      });

      // Borders
      map.addLayer({
        id: "neighborhood-borders",
        type: "line",
        source: "neighborhoods",
        paint: { "line-color": "#000", "line-width": 1 }
      });

      // Popup
      const popup = new mapboxgl.Popup({ closeButton: false, closeOnClick: false });
      map.on("mousemove", "crime-heat", (e) => {
        if (!e.features.length) return;
        const feature = e.features[0];
        const name = feature.properties.name;
        const crimeCount = feature.properties.crime_count;

        popup
          .setLngLat(e.lngLat)
          .setHTML(`<strong>${name}</strong><br/>Crimes: ${crimeCount}`)
          .addTo(map);
      });
      map.on("mouseleave", "crime-heat", () => popup.remove());

      // Toggle crime layers
      document.getElementById('toggleCrimeBtn').addEventListener('click', () => {
        const visibilityHeat = map.getLayoutProperty('crime-heat', 'visibility');
        const visibilityBorders = map.getLayoutProperty('neighborhood-borders', 'visibility');

        if (visibilityHeat === 'visible') {
          map.setLayoutProperty('crime-heat', 'visibility', 'none');
          map.setLayoutProperty('neighborhood-borders', 'visibility', 'none');
        } else {
          map.setLayoutProperty('crime-heat', 'visibility', 'visible');
          map.setLayoutProperty('neighborhood-borders', 'visibility', 'visible');
        }
      });
    });

  // Add traffic source + layers
  map.addSource("traffic", {
    type: "vector",
    url: "mapbox://mapbox.mapbox-traffic-v1"
  });

  map.addLayer({
    id: "traffic",
    type: "line",
    source: "traffic",
    "source-layer": "traffic",
    layout: { "line-cap": "round", "line-join": "round" },
    paint: {
      "line-color": [
        "case",
        ["==", ["get", "congestion"], "low"], "#2DC937",
        ["==", ["get", "congestion"], "moderate"], "#FFCC00",
        ["==", ["get", "congestion"], "heavy"], "#FF6600",
        ["==", ["get", "congestion"], "severe"], "#D7263D",
        "#999"
      ],
      "line-width": 2
    }
  });

  // Toggle traffic
  document.getElementById('toggleTrafficBtn').addEventListener('click', () => {
    const visibilityTraffic = map.getLayoutProperty('traffic', 'visibility');
    if (visibilityTraffic === 'visible') {
      map.setLayoutProperty('traffic', 'visibility', 'none');
    } else {
      map.setLayoutProperty('traffic', 'visibility', 'visible');
    }
  });
});
</script>
</body>
</html>
