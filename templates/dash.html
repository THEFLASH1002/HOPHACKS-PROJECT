<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergency Dispatch Center</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSS and JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .dashboard-container.hidden {
            display: none;
        }

        .card {
            transition: all 0.2s ease-in-out;
        }

        .card:hover {
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.4);
            cursor: pointer;
        }
        
        .pulse-indicator {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .specialty-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .specialty-available { background-color: #2ECC71; color: white; }
        .specialty-limited { background-color: #F1C40F; color: black; }
        .specialty-unavailable { background-color: #E74C3C; color: white; }
        
        .filter-btn {
            transition: all 0.2s ease-in-out;
        }
        
        .filter-btn.active {
            background-color: #3B82F6;
            color: white;
            box-shadow: 0 0 10px #3B82F6, 0 0 20px #3B82F6, 0 0 30px #3B82F6;
        }

        #map {
            height: 500px;
            border-radius: 12px;
            border: 2px solid #1f2937;
        }

        .gauge-container {
            display: flex;
            justify-content: space-around;
            margin-top: 1rem;
        }
        .gauge {
            width: 100px;
            height: 100px;
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen text-gray-100">

    <!-- Header Section (Unified for all dashboards) -->
    <div class="bg-gray-800 border-b-2 border-blue-600 p-4 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto">
            <div class="flex flex-col sm:flex-row justify-between items-center">
                <div class="text-center sm:text-left">
                    <h1 class="text-2xl sm:text-3xl font-bold text-white">Emergency Dispatch Center</h1>
                    <p class="text-blue-300 text-sm">Baltimore Metro Area</p>
                </div>
                <div class="mt-4 sm:mt-0 flex flex-wrap justify-center sm:justify-end gap-2">
                    <a href="{{ url_for('home') }}" class="px-4 py-2 bg-blue-600 rounded-md font-medium hover:bg-blue-700 transition" onclick="showDashboard('main')">
                        Home
                    </a>
                    <button class="px-4 py-2 bg-gray-700 rounded-md font-medium hover:bg-gray-600 transition" onclick="showDashboard('ems')">
                        üöë EMS
                    </button>
                    <button class="px-4 py-2 bg-gray-700 rounded-md font-medium hover:bg-gray-600 transition" onclick="showDashboard('police')">
                        üöì Police
                    </button>
                    <button class="px-4 py-2 bg-gray-700 rounded-md font-medium hover:bg-gray-600 transition" onclick="showDashboard('fire')">
                        üöí Fire
                    </button>
                    <a href="{{ url_for('map_page') }}" class="px-4 py-2 bg-gray-700 rounded-md font-medium hover:bg-gray-600 transition" onclick="showDashboard('map')">
                        üìç Map
                    </a>
                    <a href="{{ url_for('timelapse') }}" class="px-4 py-2 bg-gray-700 rounded-md font-medium hover:bg-gray-600 transition" onclick="showDashboard('timelapse')">
                        ‚è≥  Timelapse
                    </a>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard-main" class="dashboard-container max-w-7xl mx-auto p-4">
        <div id="system-status-main" class="bg-green-600 text-white p-3 rounded-lg my-4">
            <div class="max-w-4xl mx-auto text-center">
                <span class="font-semibold">üü¢ ALL SYSTEMS NORMAL</span>
                <span class="ml-4 text-sm opacity-90">Network operating at standard capacity</span>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8">
            <div class="card bg-gray-800 p-6 rounded-xl shadow-lg flex flex-col items-center text-center" onclick="showDashboard('ems')">
                <span class="text-5xl mb-4">üöë</span>
                <h2 class="text-2xl font-bold text-white">EMS Dashboard</h2>
                <p class="text-gray-400 mt-2">View real-time ambulance and hospital status.</p>
                <div class="mt-4 text-sm font-medium text-green-400">
                    <span id="ems-status">Status: Normal</span>
                </div>
            </div>
            <div class="card bg-gray-800 p-6 rounded-xl shadow-lg flex flex-col items-center text-center" onclick="showDashboard('police')">
                <span class="text-5xl mb-4">üöì</span>
                <h2 class="text-2xl font-bold text-white">Police Dashboard</h2>
                <p class="text-gray-400 mt-2">Monitor patrol units, incidents, and resource availability.</p>
                <div class="mt-4 text-sm font-medium text-green-400">
                    <span id="police-status">Status: Normal</span>
                </div>
            </div>
            <div class="card bg-gray-800 p-6 rounded-xl shadow-lg flex flex-col items-center text-center" onclick="showDashboard('fire')">
                <span class="text-5xl mb-4">üöí</span>
                <h2 class="text-2xl font-bold text-white">Fire Dashboard</h2>
                <p class="text-gray-400 mt-2">Track fire station status, apparatus, and active calls.</p>
                <div class="mt-4 text-sm font-medium text-green-400">
                    <span id="fire-status">Status: Normal</span>
                </div>
            </div>
        </div>
    </div>

    <!-- EMS Dashboard -->
    <div id="dashboard-ems" class="dashboard-container hidden max-w-4xl mx-auto p-4">
        <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
            <div class="text-center sm:text-left flex items-center space-x-4">
                <button class="text-gray-400 hover:text-white transition" onclick="goBack()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-white">üöë EMS Dispatch</h1>
                    <p class="text-blue-300 text-sm">Hospital & Ambulance Status</p>
                </div>
            </div>
            <div class="mt-2 sm:mt-0 text-center sm:text-right">
                <div class="flex items-center justify-center sm:justify-end space-x-2 mb-1">
                    <div class="pulse-indicator w-3 h-3 bg-green-400 rounded-full"></div>
                    <span class="text-green-300 font-medium">LIVE</span>
                </div>
                <p id="ems-last-updated" class="text-xs text-gray-400">Last updated: Just now</p>
            </div>
        </div>
        <div id="system-status-ems" class="bg-green-600 text-white p-3 rounded-lg">
            <div class="max-w-4xl mx-auto text-center">
                <span class="font-semibold">üü¢ ALL SYSTEMS NORMAL</span>
                <span class="ml-4 text-sm opacity-90">Network operating at standard capacity</span>
            </div>
        </div>

        <!-- EMS Performance Metrics -->
        <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-gray-800 p-6 rounded-xl text-center shadow-lg">
                <h3 class="text-xl font-bold text-white mb-2">Avg. ER Wait Time</h3>
                <div class="flex items-center justify-center space-x-2">
                    <span id="erWaitTime" class="text-6xl font-extrabold text-blue-500">0</span>
                    <span class="text-2xl text-gray-400">min</span>
                </div>
            </div>
            <div class="bg-gray-800 p-6 rounded-xl text-center shadow-lg">
                <h3 class="text-xl font-bold text-white mb-2">Overall Hospital Capacity</h3>
                <div class="flex items-center justify-center space-x-2">
                    <span id="hospitalCapacity" class="text-6xl font-extrabold text-green-500">0</span>
                    <span class="text-2xl text-gray-400">%</span>
                </div>
            </div>
        </div>

        <div class="mb-6 mt-4">
            <h2 class="text-lg font-semibold text-white mb-3">Filter & Sort Hospitals</h2>
            <div class="flex flex-wrap gap-2">
                <button class="filter-btn active px-4 py-2 rounded-full bg-blue-600 text-white text-sm font-medium" data-filter="all">
                    All Hospitals
                </button>
                <button class="filter-btn px-4 py-2 rounded-full bg-gray-700 text-gray-300 text-sm font-medium" data-filter="trauma">
                    ü©∏ Trauma
                </button>
                <button class="filter-btn px-4 py-2 rounded-full bg-gray-700 text-gray-300 text-sm font-medium" data-filter="stroke">
                    üß† Stroke
                </button>
                <button class="filter-btn px-4 py-2 rounded-full bg-gray-700 text-gray-300 text-sm font-medium" data-filter="cardiac">
                    ‚ù§Ô∏è Cardiac
                </button>
                <button class="filter-btn px-4 py-2 rounded-full bg-gray-700 text-gray-300 text-sm font-medium" data-filter="peds">
                    üë∂ Pediatric
                </button>
                <button class="filter-btn px-4 py-2 rounded-full bg-gray-700 text-gray-300 text-sm font-medium" data-filter="psych">
                    üß† Psych
                </button>
            </div>
        </div>
        <hr class="border-gray-700 my-4">
        <div id="ems-hospital-cards" class="space-y-4">
        </div>
    </div>

    <!-- Police Dashboard -->
    <div id="dashboard-police" class="dashboard-container hidden max-w-4xl mx-auto p-4">
        <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
            <div class="text-center sm:text-left flex items-center space-x-4">
                <button class="text-gray-400 hover:text-white transition" onclick="goBack()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-white">üöì Police Dispatch</h1>
                    <p class="text-blue-300 text-sm">Unit & Incident Status</p>
                </div>
            </div>
            <div class="mt-2 sm:mt-0 text-center sm:text-right">
                <div class="flex items-center justify-center sm:justify-end space-x-2 mb-1">
                    <div class="pulse-indicator w-3 h-3 bg-green-400 rounded-full"></div>
                    <span class="text-green-300 font-medium">LIVE</span>
                </div>
                <p id="police-last-updated" class="text-xs text-gray-400">Last updated: Just now</p>
            </div>
        </div>
        <div id="system-status-police" class="bg-green-600 text-white p-3 rounded-lg">
            <div class="max-w-4xl mx-auto text-center">
                <span class="font-semibold">üü¢ ALL SYSTEMS NORMAL</span>
                <span class="ml-4 text-sm opacity-90">Network operating at standard capacity</span>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-8">
            <div class="bg-gray-800 p-4 rounded-lg flex flex-col items-center justify-center">
                <div class="flex items-center space-x-2 mb-2">
                    <span class="text-3xl">üö®</span>
                    <h3 class="text-xl font-bold text-white">Incidents This Hour</h3>
                </div>
                <span id="hourly-incident-count" class="text-5xl font-extrabold text-red-500">0</span>
            </div>
            <div class="md:col-span-2 bg-gray-800 p-4 rounded-lg">
                <h3 class="text-xl font-bold text-white mb-2 text-center">Incidents by Priority</h3>
                <ul id="incident-priority-numbers" class="list-none space-y-2 p-4">
                    <!-- Numbers will be rendered here -->
                </ul>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-8" id="police-units-container">
        </div>
        <div class="mt-8">
            <h2 class="text-xl font-bold text-white mb-4">Active Incidents</h2>
            <div class="space-y-4" id="police-incidents-container">
            </div>
        </div>
    </div>

    <!-- Fire Dashboard -->
    <div id="dashboard-fire" class="dashboard-container hidden max-w-4xl mx-auto p-4">
        <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
            <div class="text-center sm:text-left flex items-center space-x-4">
                <button class="text-gray-400 hover:text-white transition" onclick="goBack()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-white">üöí Fire Dispatch</h1>
                    <p class="text-blue-300 text-sm">Station & Apparatus Status</p>
                </div>
            </div>
            <div class="mt-2 sm:mt-0 text-center sm:text-right">
                <div class="flex items-center justify-center sm:justify-end space-x-2 mb-1">
                    <div class="pulse-indicator w-3 h-3 bg-green-400 rounded-full"></div>
                    <span class="text-green-300 font-medium">LIVE</span>
                </div>
                <p id="fire-last-updated" class="text-xs text-gray-400">Last updated: Just now</p>
            </div>
        </div>
        <div id="system-status-fire" class="bg-green-600 text-white p-3 rounded-lg">
            <div class="max-w-4xl mx-auto text-center">
                <span class="font-semibold">üü¢ ALL SYSTEMS NORMAL</span>
                <span class="ml-4 text-sm opacity-90">Network operating at standard capacity</span>
            </div>
        </div>

        <!-- Fire Apparatus Numbers -->
        <div class="mt-8 bg-gray-800 p-4 rounded-lg">
            <h3 class="text-xl font-bold text-white mb-4 text-center">Apparatus Availability by Type</h3>
            <ul id="fire-apparatus-numbers" class="list-none space-y-2 p-4">
                <!-- Numbers will be rendered here -->
            </ul>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-8" id="fire-stations-container">
        </div>
    </div>

    <!-- Map Dashboard -->
    <div id="dashboard-map" class="dashboard-container max-w-7xl mx-auto p-4 hidden">
        <div class="flex items-center space-x-4 mb-4">
            <button class="text-gray-400 hover:text-white transition" onclick="goBack()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
            </button>
            <h2 class="text-3xl font-bold text-white text-center">Live GIS Map</h2>
        </div>
        <div id="map"></div>
    </div>

    <!-- Modal for Detailed Information -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-gray-800 rounded-xl max-w-2xl w-full max-h-screen overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 id="modal-title" class="text-xl font-bold text-white"></h3>
                        <button id="close-modal" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                    </div>
                    <div id="modal-content">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const dashboards = {
            main: document.getElementById('dashboard-main'),
            ems: document.getElementById('dashboard-ems'),
            police: document.getElementById('dashboard-police'),
            fire: document.getElementById('dashboard-fire'),
            map: document.getElementById('dashboard-map')
        };
        const emsContainer = document.getElementById('ems-hospital-cards');
        const policeUnitsContainer = document.getElementById('police-units-container');
        const policeIncidentsContainer = document.getElementById('police-incidents-container');
        const fireStationsContainer = document.getElementById('fire-stations-container');
        const hourlyIncidentCountDisplay = document.getElementById('hourly-incident-count');
        const erWaitTimeDisplay = document.getElementById('erWaitTime');
        const hospitalCapacityDisplay = document.getElementById('hospitalCapacity');
        const incidentPriorityNumbers = document.getElementById('incident-priority-numbers');
        const fireApparatusNumbers = document.getElementById('fire-apparatus-numbers');

        const filterButtons = document.querySelectorAll('#dashboard-ems .filter-btn');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const closeModalBtn = document.getElementById('close-modal');

        // Initial mock data, now stored globally for trending updates
        let emsData = [
            { id: 'jhh', name: 'Johns Hopkins Hospital', location: [39.2904, -76.6122], distance: 5.2, eta: 12, status: 'Accepting', waitTime: 25, erCapacity: 65, notes: 'Level I Trauma Center. All services operating normally.', specialties: { trauma: 'Level I - Available', stroke: 'Available', cardiac: 'Available', peds: 'Available', psych: 'Limited' } },
            { id: 'ummc', name: 'University of Maryland Medical Center', location: [39.2847, -76.6206], distance: 3.1, eta: 8, status: 'Capacity Alert', waitTime: 45, erCapacity: 85, notes: 'Adult Trauma Center. High ER volume, expect delays for non-critical cases.', specialties: { trauma: 'Level I - Available', stroke: 'Available', cardiac: 'Available', peds: 'Limited', psych: 'Unavailable' } },
            { id: 'medstar-franklin', name: 'MedStar Franklin Square Medical Center', location: [39.3179, -76.4950], distance: 10.5, eta: 20, status: 'Accepting', waitTime: 30, erCapacity: 75, notes: 'Designated Trauma and Stroke Center. Some cardiac services are limited due to high demand.', specialties: { trauma: 'Level II - Available', stroke: 'Available', cardiac: 'Limited', peds: 'Unavailable', psych: 'Available' } },
            { id: 'mercy', name: 'Mercy Medical Center', location: [39.2905, -76.6092], distance: 4.5, eta: 15, status: 'Accepting', waitTime: 20, erCapacity: 50, notes: 'Specializes in women and infants care.', specialties: { trauma: 'Unavailable', stroke: 'Limited', cardiac: 'Available', peds: 'Available', psych: 'Limited' } },
        ];

        let policeData = {
            units: [
                { id: 'p1', unitId: 'P-512', status: 'Available', location: [39.294, -76.61], locationName: 'Downtown Crossing' },
                { id: 'p2', unitId: 'P-513', status: 'Available', location: [39.28, -76.62], locationName: 'Federal Hill' },
                { id: 'p3', unitId: 'P-514', status: 'On Scene', location: [39.29, -76.615], locationName: 'Inner Harbor' },
            ],
            incidents: [
                { id: 'i1', callType: 'Assault', location: [39.285, -76.618], locationName: '123 Main St', priority: 'High', unitsDispatched: ['P-514'] }
            ]
        };

        let fireData = [
            { id: 'f1', stationName: 'Station 1: Inner Harbor', status: 'In Service', location: [39.288, -76.605], apparatus: [{ type: 'Engine', status: 'Available' }, { type: 'Medic', status: 'Available' }] },
            { id: 'f2', stationName: 'Station 2: Federal Hill', status: 'In Service', location: [39.27, -76.62], apparatus: [{ type: 'Engine', status: 'Available' }, { type: 'Ladder', status: 'On Call' }] },
            { id: 'f3', stationName: 'Station 3: Downtown', status: 'In Service', location: [39.295, -76.61], apparatus: [{ type: 'Ladder', status: 'Available' }] }
        ];

        let currentFilter = 'all';
        let incidentCount = 0;
        let lastIncidentCheckCount = 0;
        
        let erWaitTimeTrendDirection = 1; // 1 for increasing, -1 for decreasing
        let erWaitTimeTrendCounter = 0;
        const trendMax = 10; // trend will last for 10 updates (5 minutes)

        // Leaflet Map Initialization
        const map = L.map('map').setView([39.2904, -76.6122], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        const unitMarkers = L.layerGroup().addTo(map);
        const incidentMarkers = L.layerGroup().addTo(map);

        const emsIcon = new L.Icon({ iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34] });
        const policeIcon = new L.Icon({ iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34] });
        const fireIcon = new L.Icon({ iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34] });
        const incidentIcon = new L.Icon({ iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-black.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34] });
        
        function updateEmsMetrics() {
            const avgWaitTime = Math.round(emsData.reduce((sum, h) => sum + h.waitTime, 0) / emsData.length);
            const avgCapacity = Math.round(emsData.reduce((sum, h) => sum + h.erCapacity, 0) / emsData.length);
            
            erWaitTimeDisplay.textContent = avgWaitTime;
            hospitalCapacityDisplay.textContent = avgCapacity;
        }

        function updatePoliceNumbers() {
            const high = policeData.incidents.filter(i => i.priority === 'High').length;
            const medium = policeData.incidents.filter(i => i.priority === 'Medium').length;
            const low = policeData.incidents.filter(i => i.priority === 'Low').length;
            
            incidentPriorityNumbers.innerHTML = `
                <li class="flex justify-between items-center text-sm">
                    <span class="font-medium text-red-400">High Priority</span>
                    <span class="font-bold text-red-400">${high}</span>
                </li>
                <li class="flex justify-between items-center text-sm">
                    <span class="font-medium text-yellow-400">Medium Priority</span>
                    <span class="font-bold text-yellow-400">${medium}</span>
                </li>
                <li class="flex justify-between items-center text-sm">
                    <span class="font-medium text-green-400">Low Priority</span>
                    <span class="font-bold text-green-400">${low}</span>
                </li>
            `;
        }

        function updateFireNumbers() {
            const engines = fireData.filter(s => s.apparatus.some(a => a.type === 'Engine' && a.status === 'Available')).length;
            const ladders = fireData.filter(s => s.apparatus.some(a => a.type === 'Ladder' && a.status === 'Available')).length;
            const medics = fireData.filter(s => s.apparatus.some(a => a.type === 'Medic' && a.status === 'Available')).length;

            fireApparatusNumbers.innerHTML = `
                <li class="flex justify-between items-center text-sm">
                    <span class="font-medium text-blue-400">Engines Available</span>
                    <span class="font-bold text-blue-400">${engines}</span>
                </li>
                <li class="flex justify-between items-center text-sm">
                    <span class="font-medium text-yellow-400">Ladders Available</span>
                    <span class="font-bold text-yellow-400">${ladders}</span>
                </li>
                <li class="flex justify-between items-center text-sm">
                    <span class="font-medium text-green-400">Medics Available</span>
                    <span class="font-bold text-green-400">${medics}</span>
                </li>
            `;
        }
        
        function goBack() {
            showDashboard('main');
        }

        function showDashboard(dashboardId) {
            for (const key in dashboards) {
                dashboards[key].classList.add('hidden');
            }
            dashboards[dashboardId].classList.remove('hidden');
            if (dashboardId === 'map') {
                setTimeout(() => map.invalidateSize(), 100);
            }
        }

        // Helper functions
        function getSpecialtyIcon(status) {
            switch (status) {
                case 'Level I - Available':
                case 'Level II - Available':
                case 'Available':
                    return { icon: '‚úì', class: 'specialty-available' };
                case 'Limited':
                    return { icon: '!', class: 'specialty-limited' };
                case 'Unavailable':
                    return { icon: '‚úó', class: 'specialty-unavailable' };
                default:
                    return { icon: '?', class: 'bg-gray-500' };
            }
        }

        function renderHospitalCard(hospital) {
            const card = document.createElement('div');
            card.classList.add('card', 'bg-gray-800', 'rounded-xl', 'shadow-lg', 'p-6', 'flex', 'flex-col', 'md:flex-row', 'justify-between', 'items-start', 'md:items-center', 'hospital-card');
            card.setAttribute('data-id', hospital.id);

            let statusClasses = [];
            if (hospital.status === 'Accepting') statusClasses = ['border-l-8', 'border-green-500'];
            else if (hospital.status === 'Capacity Alert') statusClasses = ['border-l-8', 'border-yellow-500'];
            else if (hospital.status === 'Diversion') statusClasses = ['border-l-8', 'border-red-500'];
            
            if (statusClasses.length > 0) {
                card.classList.add(...statusClasses);
            }

            const specialtyIcons = Object.entries(hospital.specialties).map(([name, status]) => {
                const { icon, class: iconClass } = getSpecialtyIcon(status);
                const emoji = { 'trauma': 'ü©∏', 'stroke': 'üß†', 'cardiac': '‚ù§Ô∏è', 'peds': 'üë∂', 'psych': 'üß†' }[name] || '';
                const display = name.charAt(0).toUpperCase() + name.slice(1);
                return `<span class="flex items-center gap-1">${emoji} ${display}: <span class="specialty-icon ${iconClass}">${icon}</span></span>`;
            }).join('');

            card.innerHTML = `
                <div class="w-full md:w-3/5">
                    <h3 class="text-xl font-bold text-white mb-1">${hospital.name}</h3>
                    <p class="text-sm text-gray-400 mb-2">Distance: ${hospital.distance} miles ‚Ä¢ ETA: ${hospital.eta} min</p>
                    <div class="flex flex-wrap gap-2 mb-3">
                        <span class="bg-blue-600 text-white text-xs font-semibold px-2 py-1 rounded-full">Status: ${hospital.status}</span>
                        <span class="bg-gray-700 text-gray-300 text-xs font-semibold px-2 py-1 rounded-full">ER Wait Time: <span class="font-bold text-white">${hospital.waitTime} min</span></span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-2.5">
                        <div class="capacity-bar h-2.5 rounded-full" style="width: ${hospital.erCapacity}%; background-color: ${hospital.erCapacity > 80 ? '#E74C3C' : (hospital.erCapacity > 60 ? '#F1C40F' : '#2ECC71')};"></div>
                    </div>
                    <p class="text-xs text-gray-400 mt-1">ER Capacity: ${hospital.erCapacity}%</p>
                </div>
                <div class="w-full md:w-2/5 mt-4 md:mt-0 md:text-right">
                    <div class="flex flex-wrap md:justify-end gap-2 text-sm text-gray-400">
                        ${specialtyIcons}
                    </div>
                </div>
            `;
            card.onclick = () => showModal(hospital, 'ems');
            return card;
        }

        function renderPoliceUnitCard(unit) {
            const statusColor = unit.status === 'Available' ? 'bg-green-600' : 'bg-yellow-600';
            const card = document.createElement('div');
            card.classList.add('card', 'bg-gray-800', 'p-4', 'rounded-lg', 'shadow');
            card.innerHTML = `
                <h4 class="font-bold text-lg">${unit.unitId}</h4>
                <p class="text-gray-400 text-sm">Status: <span class="${statusColor} text-white px-2 py-0.5 rounded-full text-xs">${unit.status}</span></p>
                <p class="text-gray-400 text-sm">Location: ${unit.locationName}</p>
            `;
            card.onclick = () => showModal(unit, 'police-unit');
            return card;
        }

        function renderPoliceIncidentCard(incident) {
            const priorityColor = incident.priority === 'High' ? 'bg-red-600' : (incident.priority === 'Medium' ? 'bg-yellow-600' : 'bg-green-600');
            const card = document.createElement('div');
            card.classList.add('card', 'bg-gray-800', 'p-6', 'rounded-lg', 'shadow-md', 'border-l-4', `border-${incident.priority === 'High' ? 'red' : (incident.priority === 'Medium' ? 'yellow' : 'green')}-500`);
            card.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <h4 class="text-xl font-semibold">${incident.callType}</h4>
                    <span class="px-2 py-0.5 rounded-full text-xs font-bold ${priorityColor} text-white">${incident.priority}</span>
                </div>
                <p class="text-gray-400">Location: ${incident.locationName}</p>
                <p class="text-gray-400 text-sm mt-1">Units Dispatched: ${incident.unitsDispatched.join(', ')}</p>
            `;
            card.onclick = () => showModal(incident, 'police-incident');
            return card;
        }

        function renderFireStationCard(station) {
            const card = document.createElement('div');
            card.classList.add('card', 'bg-gray-800', 'p-6', 'rounded-lg', 'shadow-md');
            card.innerHTML = `
                <h4 class="text-xl font-bold">${station.stationName}</h4>
                <p class="text-gray-400 text-sm">Status: <span class="text-green-400">${station.status}</span></p>
                <div class="mt-4">
                    <p class="text-sm font-semibold">Apparatus Available:</p>
                    <ul class="list-disc list-inside text-gray-400 text-sm mt-1">
                        ${station.apparatus.map(app => `<li>${app.type} (${app.status})</li>`).join('')}
                    </ul>
                </div>
            `;
            card.onclick = () => showModal(station, 'fire-station');
            return card;
        }

        // Dashboard Rendering Functions
        function renderEmsDashboard() {
            emsContainer.innerHTML = ''; // Clear the container
            let filteredCards = [...emsData];
            if (currentFilter !== 'all') {
                filteredCards = filteredCards.filter(hospital => 
                    hospital.specialties[currentFilter] && hospital.specialties[currentFilter] !== 'Unavailable'
                );
            }
            filteredCards.sort((a, b) => {
                const statusOrder = { 'Accepting': 1, 'Capacity Alert': 2, 'Diversion': 3, 'Closed': 4 };
                const aStatus = statusOrder[a.status] || 5;
                const bStatus = statusOrder[b.status] || 5;
                if (aStatus !== bStatus) return aStatus - bStatus;
                return a.distance - b.distance;
            });
            filteredCards.forEach(hospital => emsContainer.appendChild(renderHospitalCard(hospital)));
        }

        function renderPoliceDashboard() {
            policeUnitsContainer.innerHTML = '';
            policeData.units.forEach(unit => policeUnitsContainer.appendChild(renderPoliceUnitCard(unit)));

            policeIncidentsContainer.innerHTML = '';
            policeData.incidents.forEach(incident => policeIncidentsContainer.appendChild(renderPoliceIncidentCard(incident)));
        }
        
        function renderFireDashboard() {
            fireStationsContainer.innerHTML = '';
            fireData.forEach(station => fireStationsContainer.appendChild(renderFireStationCard(station)));
        }

        function renderMap() {
            unitMarkers.clearLayers();
            incidentMarkers.clearLayers();

            policeData.units.forEach(unit => {
                const marker = L.marker(unit.location, { icon: policeIcon }).addTo(unitMarkers);
                marker.bindPopup(`<b>${unit.unitId}</b><br>Status: ${unit.status}<br>Location: ${unit.locationName}`);
            });
            
            policeData.incidents.forEach(incident => {
                const marker = L.marker(incident.location, { icon: incidentIcon }).addTo(incidentMarkers);
                marker.bindPopup(`<b>${incident.callType}</b><br>Priority: ${incident.priority}<br>Location: ${incident.locationName}`);
            });
            
            emsData.forEach(hospital => {
                const marker = L.marker(hospital.location, { icon: emsIcon }).addTo(unitMarkers);
                marker.bindPopup(`<b>${hospital.name}</b><br>Status: ${hospital.status}<br>Wait Time: ${hospital.waitTime} min`);
            });
            
            fireData.forEach(station => {
                const marker = L.marker(station.location, { icon: fireIcon }).addTo(unitMarkers);
                marker.bindPopup(`<b>${station.stationName}</b><br>Status: ${station.status}`);
            });
        }

        function showModal(data, type) {
            modal.classList.remove('hidden');
            let content = '';
            switch(type) {
                case 'ems':
                    modalTitle.textContent = data.name;
                    const specialtyDetails = Object.entries(data.specialties).map(([name, status]) => `<li><span class="font-bold">${name.charAt(0).toUpperCase() + name.slice(1)}:</span> ${status}</li>`).join('');
                    content = `
                        <p class="text-gray-400 mb-2">${data.notes}</p>
                        <ul class="space-y-1">
                            <li><span class="font-semibold text-white">Status:</span> ${data.status}</li>
                            <li><span class="font-semibold text-white">ER Wait Time:</span> ${data.waitTime} min</li>
                            <li><span class="font-semibold text-white">ER Capacity:</span> ${data.erCapacity}%</li>
                            <li><span class="font-semibold text-white">Distance:</span> ${data.distance} miles</li>
                        </ul>
                        <h4 class="font-semibold text-white mt-4 mb-2">Specialty Services:</h4>
                        <ul class="list-disc list-inside text-gray-400">${specialtyDetails}</ul>
                    `;
                    break;
                case 'police-unit':
                    modalTitle.textContent = data.unitId;
                    content = `
                        <p class="text-gray-400 mb-2">Unit Status and Location Details</p>
                        <ul class="space-y-1">
                            <li><span class="font-semibold text-white">Status:</span> ${data.status}</li>
                            <li><span class="font-semibold text-white">Last Known Location:</span> ${data.locationName}</li>
                            <li><span class="font-semibold text-white">Coordinates:</span> [${data.location[0]}, ${data.location[1]}]</li>
                        </ul>
                    `;
                    break;
                case 'police-incident':
                    modalTitle.textContent = `Incident: ${data.callType}`;
                    content = `
                        <p class="text-gray-400 mb-2">Incident Details</p>
                        <ul class="space-y-1">
                            <li><span class="font-semibold text-white">Priority:</span> ${data.priority}</li>
                            <li><span class="font-semibold text-white">Location:</span> ${data.locationName}</li>
                            <li><span class="font-semibold text-white">Units Dispatched:</span> ${data.unitsDispatched.join(', ')}</li>
                        </ul>
                    `;
                    break;
                case 'fire-station':
                    modalTitle.textContent = data.stationName;
                    const apparatusList = data.apparatus.map(app => `<li>${app.type} - ${app.status}</li>`).join('');
                    content = `
                        <p class="text-gray-400 mb-2">Apparatus and Station Status</p>
                        <ul class="space-y-1">
                            <li><span class="font-semibold text-white">Status:</span> ${data.status}</li>
                        </ul>
                        <h4 class="font-semibold text-white mt-4 mb-2">Apparatus:</h4>
                        <ul class="list-disc list-inside text-gray-400">${apparatusList}</ul>
                    `;
                    break;
            }
            modalContent.innerHTML = content;
        }

        closeModalBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
        });

        // Close modal when clicking outside
        modal.addEventListener('click', (e) => {
            if (e.target.id === 'modal') {
                modal.classList.add('hidden');
            }
        });

        // Event listeners for filter buttons
        filterButtons.forEach(button => {
            button.addEventListener('click', () => {
                filterButtons.forEach(btn => btn.classList.remove('active', 'bg-blue-600', 'text-white'));
                filterButtons.forEach(btn => btn.classList.add('bg-gray-700', 'text-gray-300'));
                button.classList.add('active', 'bg-blue-600', 'text-white');
                button.classList.remove('bg-gray-700', 'text-gray-300');
                currentFilter = button.getAttribute('data-filter');
                renderEmsDashboard();
            });
        });

        function updateData() {
            // Trend ER wait times and capacity
            erWaitTimeTrendCounter++;
            if (erWaitTimeTrendCounter >= trendMax) {
                erWaitTimeTrendDirection *= -1;
                erWaitTimeTrendCounter = 0;
            }
            emsData.forEach(hospital => {
                hospital.waitTime += erWaitTimeTrendDirection * Math.floor(Math.random() * 3);
                hospital.waitTime = Math.max(0, hospital.waitTime);
                hospital.erCapacity += erWaitTimeTrendDirection * Math.floor(Math.random() * 3);
                hospital.erCapacity = Math.min(100, Math.max(0, hospital.erCapacity));
            });
            // Randomly change a hospital status
            const randomHospital = emsData[Math.floor(Math.random() * emsData.length)];
            const statuses = ['Accepting', 'Capacity Alert', 'Diversion'];
            if (Math.random() < 0.2) { // 20% chance to change status
                randomHospital.status = statuses[Math.floor(Math.random() * statuses.length)];
            }
            
            // Randomly update a police unit status
            const randomPoliceUnit = policeData.units[Math.floor(Math.random() * policeData.units.length)];
            const policeStatuses = ['Available', 'On Scene', 'Dispatched'];
            randomPoliceUnit.status = policeStatuses[Math.floor(Math.random() * policeStatuses.length)];
            
            // Randomly update a fire apparatus status
            const randomFireStation = fireData[Math.floor(Math.random() * fireData.length)];
            const randomApparatus = randomFireStation.apparatus[Math.floor(Math.random() * randomFireStation.apparatus.length)];
            const fireStatuses = ['Available', 'On Call', 'Out of Service'];
            randomApparatus.status = fireStatuses[Math.floor(Math.random() * fireStatuses.length)];

            // Randomly add or clear an incident
            if (Math.random() < 0.1) { // 10% chance to add an incident
                const callTypes = ['Assault', 'Burglary', 'Traffic Stop', 'Noise Complaint', 'Structure Fire', 'Medical Emergency'];
                const priorities = ['High', 'Medium', 'Low'];
                const newIncident = {
                    id: 'i' + (policeData.incidents.length + 1),
                    callType: callTypes[Math.floor(Math.random() * callTypes.length)],
                    location: [39.2904 + (Math.random() - 0.5) * 0.02, -76.6122 + (Math.random() - 0.5) * 0.02],
                    locationName: 'New Incident Location',
                    priority: priorities[Math.floor(Math.random() * priorities.length)],
                    unitsDispatched: []
                };
                policeData.incidents.push(newIncident);
            }
            if (Math.random() < 0.05 && policeData.incidents.length > 0) { // 5% chance to clear an incident
                policeData.incidents.splice(Math.floor(Math.random() * policeData.incidents.length), 1);
            }
            
            const now = new Date();
            const timeString = now.toLocaleTimeString();

            // Check if incident count has changed for hourly counter
            if (policeData.incidents.length !== lastIncidentCheckCount) {
                incidentCount = policeData.incidents.length;
                hourlyIncidentCountDisplay.textContent = incidentCount;
                lastIncidentCheckCount = incidentCount;
            }

            // Update dashboards and metrics
            updateEmsMetrics();
            updatePoliceNumbers();
            updateFireNumbers();
            renderEmsDashboard();
            renderPoliceDashboard();
            renderFireDashboard();
            renderMap();
        }

        // Initial render and data updates
        updateData();
        setInterval(updateData, 3000); // Update data every 3 seconds

    </script>
</body>
</html>