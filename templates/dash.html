<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergency Dispatch Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha2d1-tJ6o5n/z09l55K3x2t30X6p/L6pWw9Kx9Kz9K9z/nQ==" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha2d1-tJ6o5n/z09l55K3x2t30X6p/L6pWw9Kx9Kz9K9z/nQ==" crossorigin=""></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .dashboard-container.hidden {
            display: none;
        }

        .card {
            transition: all 0.2s ease-in-out;
        }

        .card:hover {
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.4);
            cursor: pointer;
        }
        
        .pulse-indicator {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .specialty-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .specialty-available { background-color: #2ECC71; color: white; }
        .specialty-limited { background-color: #F1C40F; color: black; }
        .specialty-unavailable { background-color: #E74C3C; color: white; }
        
        .filter-btn {
            transition: all 0.2s ease-in-out;
        }
        
        .filter-btn.active {
            background-color: #3B82F6;
            color: white;
            box-shadow: 0 0 10px #3B82F6, 0 0 20px #3B82F6, 0 0 30px #3B82F6;
        }

        #map {
            height: 500px;
            border-radius: 12px;
            border: 2px solid #1f2937;
        }

        .gauge-container {
            display: flex;
            justify-content: space-around;
            margin-top: 1rem;
        }
        .gauge {
            width: 100px;
            height: 100px;
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen text-gray-100">

    <!-- Header Section (Unified for all dashboards) -->
    <div class="bg-gray-800 border-b-2 border-blue-600 p-4 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto">
            <div class="flex flex-col sm:flex-row justify-between items-center">
                <div class="text-center sm:text-left">
                    <h1 class="text-2xl sm:text-3xl font-bold text-white">Emergency Dispatch Center</h1>
                    <p class="text-blue-300 text-sm">Baltimore Metro Area</p>
                </div>
                <div class="mt-4 sm:mt-0 flex flex-wrap justify-center sm:justify-end gap-2">
                    <!-- The Home button link has been verified and is now an anchor tag with href="home.html" -->
                    <a href="home.html" class="px-4 py-2 bg-blue-600 rounded-md font-medium hover:bg-blue-700 transition">
                        Home
                    </a>
                    <button class="px-4 py-2 bg-gray-700 rounded-md font-medium hover:bg-gray-600 transition" onclick="showDashboard('ems')">
                        üöë EMS
                    </button>
                    <button class="px-4 py-2 bg-gray-700 rounded-md font-medium hover:bg-gray-600 transition" onclick="showDashboard('police')">
                        üöì Police
                    </button>
                    <button class="px-4 py-2 bg-gray-700 rounded-md font-medium hover:bg-gray-600 transition" onclick="showDashboard('fire')">
                        üöí Fire
                    </button>
                    <button class="px-4 py-2 bg-gray-700 rounded-md font-medium hover:bg-gray-600 transition" onclick="showDashboard('map')">
                        üìç Map
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard-main" class="dashboard-container max-w-7xl mx-auto p-4">
        <div id="system-status-main" class="bg-green-600 text-white p-3 rounded-lg my-4">
            <div class="max-w-4xl mx-auto text-center">
                <span class="font-semibold">üü¢ ALL SYSTEMS NORMAL</span>
                <span class="ml-4 text-sm opacity-90">Network operating at standard capacity</span>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8">
            <div class="card bg-gray-800 p-6 rounded-xl shadow-lg flex flex-col items-center text-center" onclick="showDashboard('ems')">
                <span class="text-5xl mb-4">üöë</span>
                <h2 class="text-2xl font-bold text-white">EMS Dashboard</h2>
                <p class="text-gray-400 mt-2">View real-time ambulance and hospital status.</p>
                <div class="mt-4 text-sm font-medium text-green-400">
                    <span id="ems-status">Status: Normal</span>
                </div>
            </div>
            <div class="card bg-gray-800 p-6 rounded-xl shadow-lg flex flex-col items-center text-center" onclick="showDashboard('police')">
                <span class="text-5xl mb-4">üöì</span>
                <h2 class="text-2xl font-bold text-white">Police Dashboard</h2>
                <p class="text-gray-400 mt-2">Monitor patrol units, incidents, and resource availability.</p>
                <div class="mt-4 text-sm font-medium text-green-400">
                    <span id="police-status">Status: Normal</span>
                </div>
            </div>
            <div class="card bg-gray-800 p-6 rounded-xl shadow-lg flex flex-col items-center text-center" onclick="showDashboard('fire')">
                <span class="text-5xl mb-4">üöí</span>
                <h2 class="text-2xl font-bold text-white">Fire Dashboard</h2>
                <p class="text-gray-400 mt-2">Track fire station status, apparatus, and active calls.</p>
                <div class="mt-4 text-sm font-medium text-green-400">
                    <span id="fire-status">Status: Normal</span>
                </div>
            </div>
        </div>
    </div>

    <!-- EMS Dashboard -->
    <div id="dashboard-ems" class="dashboard-container hidden max-w-4xl mx-auto p-4">
        <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
            <div class="text-center sm:text-left">
                <h1 class="text-2xl sm:text-3xl font-bold text-white">üöë EMS Dispatch</h1>
                <p class="text-blue-300 text-sm">Hospital & Ambulance Status</p>
            </div>
            <div class="mt-2 sm:mt-0 text-center sm:text-right">
                <div class="flex items-center justify-center sm:justify-end space-x-2 mb-1">
                    <div class="pulse-indicator w-3 h-3 bg-green-400 rounded-full"></div>
                    <span class="text-green-300 font-medium">LIVE</span>
                </div>
                <p id="ems-last-updated" class="text-xs text-gray-400">Last updated: Just now</p>
            </div>
        </div>
        <div id="system-status-ems" class="bg-green-600 text-white p-3 rounded-lg">
            <div class="max-w-4xl mx-auto text-center">
                <span class="font-semibold">üü¢ ALL SYSTEMS NORMAL</span>
                <span class="ml-4 text-sm opacity-90">Network operating at standard capacity</span>
            </div>
        </div>

        <!-- EMS Performance Gauges -->
        <div class="mt-8 bg-gray-800 p-4 rounded-lg">
            <h3 class="text-xl font-bold mb-4 text-white text-center">System Performance Metrics</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-gray-700 p-4 rounded-lg text-center">
                    <h4 class="text-lg font-semibold text-gray-300 mb-2">Average ER Wait Time</h4>
                    <canvas id="erWaitTimeGauge" class="gauge-chart"></canvas>
                </div>
                <div class="bg-gray-700 p-4 rounded-lg text-center">
                    <h4 class="text-lg font-semibold text-gray-300 mb-2">Overall Hospital Capacity</h4>
                    <canvas id="hospitalCapacityGauge" class="gauge-chart"></canvas>
                </div>
            </div>
        </div>

        <div class="mb-6 mt-4">
            <h2 class="text-lg font-semibold text-white mb-3">Filter & Sort Hospitals</h2>
            <div class="flex flex-wrap gap-2">
                <button class="filter-btn active px-4 py-2 rounded-full bg-gray-700 text-gray-300 text-sm font-medium" data-filter="all">
                    All Hospitals
                </button>
                <button class="filter-btn px-4 py-2 rounded-full bg-gray-700 text-gray-300 text-sm font-medium" data-filter="trauma">
                    ü©∏ Trauma
                </button>
                <button class="filter-btn px-4 py-2 rounded-full bg-gray-700 text-gray-300 text-sm font-medium" data-filter="stroke">
                    üß† Stroke
                </button>
                <button class="filter-btn px-4 py-2 rounded-full bg-gray-700 text-gray-300 text-sm font-medium" data-filter="cardiac">
                    ‚ù§Ô∏è Cardiac
                </button>
                <button class="filter-btn px-4 py-2 rounded-full bg-gray-700 text-gray-300 text-sm font-medium" data-filter="peds">
                    üë∂ Pediatric
                </button>
                <button class="filter-btn px-4 py-2 rounded-full bg-gray-700 text-gray-300 text-sm font-medium" data-filter="psych">
                    üß† Psych
                </button>
            </div>
        </div>
        <hr class="border-gray-700 my-4">
        <div id="ems-hospital-cards" class="space-y-4">
        </div>
    </div>

    <!-- Police Dashboard -->
    <div id="dashboard-police" class="dashboard-container hidden max-w-4xl mx-auto p-4">
        <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
            <div class="text-center sm:text-left">
                <h1 class="text-2xl sm:text-3xl font-bold text-white">üöì Police Dispatch</h1>
                <p class="text-blue-300 text-sm">Unit & Incident Status</p>
            </div>
            <div class="mt-2 sm:mt-0 text-center sm:text-right">
                <div class="flex items-center justify-center sm:justify-end space-x-2 mb-1">
                    <div class="pulse-indicator w-3 h-3 bg-green-400 rounded-full"></div>
                    <span class="text-green-300 font-medium">LIVE</span>
                </div>
                <p id="police-last-updated" class="text-xs text-gray-400">Last updated: Just now</p>
            </div>
        </div>
        <div id="system-status-police" class="bg-green-600 text-white p-3 rounded-lg">
            <div class="max-w-4xl mx-auto text-center">
                <span class="font-semibold">üü¢ ALL SYSTEMS NORMAL</span>
                <span class="ml-4 text-sm opacity-90">Network operating at standard capacity</span>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-8">
            <div class="bg-gray-800 p-4 rounded-lg flex flex-col items-center justify-center">
                <div class="flex items-center space-x-2 mb-2">
                    <span class="text-3xl">üö®</span>
                    <h3 class="text-xl font-bold text-white">Incidents This Hour</h3>
                </div>
                <span id="hourly-incident-count" class="text-5xl font-extrabold text-red-500">0</span>
            </div>
            <div class="md:col-span-2 bg-gray-800 p-4 rounded-lg">
                <h3 class="text-xl font-bold text-white mb-2 text-center">Incidents by Priority</h3>
                <canvas id="incidentPriorityChart"></canvas>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-8" id="police-units-container">
        </div>
        <div class="mt-8">
            <h2 class="text-xl font-bold text-white mb-4">Active Incidents</h2>
            <div class="space-y-4" id="police-incidents-container">
            </div>
        </div>
    </div>

    <!-- Fire Dashboard -->
    <div id="dashboard-fire" class="dashboard-container hidden max-w-4xl mx-auto p-4">
        <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
            <div class="text-center sm:text-left">
                <h1 class="text-2xl sm:text-3xl font-bold text-white">üöí Fire Dispatch</h1>
                <p class="text-blue-300 text-sm">Station & Apparatus Status</p>
            </div>
            <div class="mt-2 sm:mt-0 text-center sm:text-right">
                <div class="flex items-center justify-center sm:justify-end space-x-2 mb-1">
                    <div class="pulse-indicator w-3 h-3 bg-green-400 rounded-full"></div>
                    <span class="text-green-300 font-medium">LIVE</span>
                </div>
                <p id="fire-last-updated" class="text-xs text-gray-400">Last updated: Just now</p>
            </div>
        </div>
        <div id="system-status-fire" class="bg-green-600 text-white p-3 rounded-lg">
            <div class="max-w-4xl mx-auto text-center">
                <span class="font-semibold">üü¢ ALL SYSTEMS NORMAL</span>
                <span class="ml-4 text-sm opacity-90">Network operating at standard capacity</span>
            </div>
        </div>

        <!-- Fire Apparatus Chart -->
        <div class="mt-8 bg-gray-800 p-4 rounded-lg">
            <h3 class="text-xl font-bold text-white mb-4 text-center">Apparatus Availability by Type</h3>
            <canvas id="fireApparatusChart"></canvas>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-8" id="fire-stations-container">
        </div>
    </div>

    <!-- Map Dashboard -->
    <div id="dashboard-map" class="dashboard-container max-w-7xl mx-auto p-4 hidden">
        <h2 class="text-3xl font-bold text-white text-center mb-4">Live GIS Map</h2>
        <div id="map"></div>
    </div>

    <!-- Modal for Detailed Information -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-gray-800 rounded-xl max-w-2xl w-full max-h-screen overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 id="modal-title" class="text-xl font-bold text-white"></h3>
                        <button id="close-modal" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                    </div>
                    <div id="modal-content">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const dashboards = {
            main: document.getElementById('dashboard-main'),
            ems: document.getElementById('dashboard-ems'),
            police: document.getElementById('dashboard-police'),
            fire: document.getElementById('dashboard-fire'),
            map: document.getElementById('dashboard-map')
        };
        const emsContainer = document.getElementById('ems-hospital-cards');
        const policeUnitsContainer = document.getElementById('police-units-container');
        const policeIncidentsContainer = document.getElementById('police-incidents-container');
        const fireStationsContainer = document.getElementById('fire-stations-container');
        const hourlyIncidentCountDisplay = document.getElementById('hourly-incident-count');

        const filterButtons = document.querySelectorAll('#dashboard-ems .filter-btn');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const closeModalBtn = document.getElementById('close-modal');

        // Initial mock data, now stored globally for trending updates
        let emsData = [
            { id: 'jhh', name: 'Johns Hopkins Hospital', location: [39.2904, -76.6122], distance: 5.2, eta: 12, status: 'Accepting', waitTime: 25, erCapacity: 65, notes: 'Level I Trauma Center. All services operating normally.', specialties: { trauma: 'Level I - Available', stroke: 'Available', cardiac: 'Available', peds: 'Available', psych: 'Limited' } },
            { id: 'ummc', name: 'University of Maryland Medical Center', location: [39.2847, -76.6206], distance: 3.1, eta: 8, status: 'Capacity Alert', waitTime: 45, erCapacity: 85, notes: 'Adult Trauma Center. High ER volume, expect delays for non-critical cases.', specialties: { trauma: 'Level I - Available', stroke: 'Available', cardiac: 'Available', peds: 'Limited', psych: 'Unavailable' } },
            { id: 'medstar-franklin', name: 'MedStar Franklin Square Medical Center', location: [39.3179, -76.4950], distance: 10.5, eta: 20, status: 'Accepting', waitTime: 30, erCapacity: 75, notes: 'Designated Trauma and Stroke Center. Some cardiac services are limited due to high demand.', specialties: { trauma: 'Level II - Available', stroke: 'Available', cardiac: 'Limited', peds: 'Unavailable', psych: 'Available' } },
        ];

        let policeData = { units: [], incidents: [] };
        let fireData = [];
        let currentFilter = 'all';
        let incidentCount = 0;
        let lastIncidentCheckCount = 0;
        
        // New variables for controlling the subtle data trend
        let erWaitTimeTrendDirection = 1; // 1 for increasing, -1 for decreasing
        let erWaitTimeTrendCounter = 0;
        const trendMax = 10; // trend will last for 10 updates (5 minutes)

        // Leaflet Map Initialization
        const map = L.map('map').setView([39.2904, -76.6122], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        const unitMarkers = L.layerGroup().addTo(map);
        const incidentMarkers = L.layerGroup().addTo(map);

        const emsIcon = new L.Icon({ iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34] });
        const policeIcon = new L.Icon({ iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34] });
        const fireIcon = new L.Icon({ iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34] });
        const incidentIcon = new L.Icon({ iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-black.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34] });

        // Chart.js initialization variables
        let erWaitTimeGauge, hospitalCapacityGauge, incidentPriorityChart, fireApparatusChart;

        function initializeCharts() {
            const gaugeChartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                cutoutPercentage: 75,
                rotation: -0.5 * Math.PI,
                circumference: 1.5 * Math.PI,
                tooltips: { enabled: false },
                plugins: { legend: { display: false }, datalabels: { display: false } }
            };

            erWaitTimeGauge = new Chart(document.getElementById('erWaitTimeGauge').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Wait Time', 'Max Time'],
                    datasets: [{
                        data: [0, 60],
                        backgroundColor: ['#3B82F6', '#1f2937'],
                        borderWidth: 0
                    }]
                },
                options: gaugeChartOptions
            });

            hospitalCapacityGauge = new Chart(document.getElementById('hospitalCapacityGauge').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Capacity', 'Remaining'],
                    datasets: [{
                        data: [0, 100],
                        backgroundColor: ['#2ECC71', '#1f2937'],
                        borderWidth: 0
                    }]
                },
                options: gaugeChartOptions
            });

            incidentPriorityChart = new Chart(document.getElementById('incidentPriorityChart').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['High', 'Medium', 'Low'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#E74C3C', '#F1C40F', '#2ECC71'],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { color: 'white' } } }
                }
            });

            fireApparatusChart = new Chart(document.getElementById('fireApparatusChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['Engine', 'Ladder', 'Medic'],
                    datasets: [{
                        label: 'Available Apparatus',
                        data: [0, 0, 0],
                        backgroundColor: ['#3B82F6', '#2ECC71', '#F1C40F'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { color: 'white' } },
                        x: { ticks: { color: 'white' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }
        
        function updateEmsCharts() {
            const avgWaitTime = emsData.reduce((sum, h) => sum + h.waitTime, 0) / emsData.length;
            const avgCapacity = emsData.reduce((sum, h) => sum + h.erCapacity, 0) / emsData.length;
            
            erWaitTimeGauge.data.datasets[0].data = [avgWaitTime, 60 - avgWaitTime];
            erWaitTimeGauge.update();

            hospitalCapacityGauge.data.datasets[0].data = [avgCapacity, 100 - avgCapacity];
            hospitalCapacityGauge.update();
        }

        function updatePoliceCharts() {
            const high = policeData.incidents.filter(i => i.priority === 'High').length;
            const medium = policeData.incidents.filter(i => i.priority === 'Medium').length;
            const low = policeData.incidents.filter(i => i.priority === 'Low').length;
            incidentPriorityChart.data.datasets[0].data = [high, medium, low];
            incidentPriorityChart.update();
        }

        function updateFireCharts() {
            const engines = fireData.filter(s => s.apparatus.some(a => a.type === 'Engine' && a.status === 'Available')).length;
            const ladders = fireData.filter(s => s.apparatus.some(a => a.type === 'Ladder' && a.status === 'Available')).length;
            const medics = fireData.filter(s => s.apparatus.some(a => a.type === 'Medic' && a.status === 'Available')).length;
            fireApparatusChart.data.datasets[0].data = [engines, ladders, medics];
            fireApparatusChart.update();
        }

        function showDashboard(dashboardId) {
            for (const key in dashboards) {
                dashboards[key].classList.add('hidden');
            }
            dashboards[dashboardId].classList.remove('hidden');
            if (dashboardId === 'map') {
                setTimeout(() => map.invalidateSize(), 100);
            }
        }

        // Helper functions
        function getSpecialtyIcon(status) {
            switch (status) {
                case 'Level I - Available':
                case 'Level II - Available':
                case 'Available':
                    return { icon: '‚úì', class: 'specialty-available' };
                case 'Limited':
                    return { icon: '!', class: 'specialty-limited' };
                case 'Unavailable':
                    return { icon: '‚úó', class: 'specialty-unavailable' };
                default:
                    return { icon: '?', class: 'bg-gray-500' };
            }
        }

        function renderHospitalCard(hospital) {
            const card = document.createElement('div');
            card.classList.add('card', 'bg-gray-800', 'rounded-xl', 'shadow-lg', 'p-6', 'flex', 'flex-col', 'md:flex-row', 'justify-between', 'items-start', 'md:items-center', 'hospital-card');
            card.setAttribute('data-id', hospital.id);

            let statusClasses = [];
            if (hospital.status === 'Accepting') statusClasses = ['border-l-8', 'border-green-500'];
            else if (hospital.status === 'Capacity Alert') statusClasses = ['border-l-8', 'border-yellow-500'];
            else if (hospital.status === 'Diversion') statusClasses = ['border-l-8', 'border-red-500'];
            
            if (statusClasses.length > 0) {
                card.classList.add(...statusClasses);
            }

            const specialtyIcons = Object.entries(hospital.specialties).map(([name, status]) => {
                const { icon, class: iconClass } = getSpecialtyIcon(status);
                const emoji = { 'trauma': 'ü©∏', 'stroke': 'üß†', 'cardiac': '‚ù§Ô∏è', 'peds': 'üë∂', 'psych': 'üß†' }[name] || '';
                const display = name.charAt(0).toUpperCase() + name.slice(1);
                return `<span class="flex items-center gap-1">${emoji} ${display}: <span class="specialty-icon ${iconClass}">${icon}</span></span>`;
            }).join('');

            card.innerHTML = `
                <div class="w-full md:w-3/5">
                    <h3 class="text-xl font-bold text-white mb-1">${hospital.name}</h3>
                    <p class="text-sm text-gray-400 mb-2">Distance: ${hospital.distance} miles ‚Ä¢ ETA: ${hospital.eta} min</p>
                    <div class="flex flex-wrap gap-2 mb-3">
                        <span class="bg-blue-600 text-white text-xs font-semibold px-2 py-1 rounded-full">Status: ${hospital.status}</span>
                        <span class="bg-gray-700 text-gray-300 text-xs font-semibold px-2 py-1 rounded-full">ER Wait Time: <span class="font-bold text-white">${hospital.waitTime} min</span></span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-2.5">
                        <div class="capacity-bar h-2.5 rounded-full" style="width: ${hospital.erCapacity}%; background-color: ${hospital.erCapacity > 80 ? '#E74C3C' : (hospital.erCapacity > 60 ? '#F1C40F' : '#2ECC71')};"></div>
                    </div>
                    <p class="text-xs text-gray-400 mt-1">ER Capacity: ${hospital.erCapacity}%</p>
                </div>
                <div class="w-full md:w-2/5 mt-4 md:mt-0 md:text-right">
                    <div class="flex flex-wrap md:justify-end gap-2 text-sm text-gray-400">
                        ${specialtyIcons}
                    </div>
                </div>
            `;
            card.onclick = () => showModal(hospital, 'ems');
            return card;
        }

        function renderPoliceUnitCard(unit) {
            const statusColor = unit.status === 'Available' ? 'bg-green-600' : 'bg-yellow-600';
            const card = document.createElement('div');
            card.classList.add('card', 'bg-gray-800', 'p-4', 'rounded-lg', 'shadow');
            card.innerHTML = `
                <h4 class="font-bold text-lg">${unit.unitId}</h4>
                <p class="text-gray-400 text-sm">Status: <span class="${statusColor} text-white px-2 py-0.5 rounded-full text-xs">${unit.status}</span></p>
                <p class="text-gray-400 text-sm">Location: ${unit.locationName}</p>
            `;
            return card;
        }

        function renderPoliceIncidentCard(incident) {
            const priorityColor = incident.priority === 'High' ? 'bg-red-600' : (incident.priority === 'Medium' ? 'bg-yellow-600' : 'bg-green-600');
            const card = document.createElement('div');
            card.classList.add('card', 'bg-gray-800', 'p-6', 'rounded-lg', 'shadow-md', 'border-l-4', 'border-red-500');
            card.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <h4 class="text-xl font-semibold">${incident.callType}</h4>
                    <span class="px-2 py-0.5 rounded-full text-xs font-bold ${priorityColor} text-white">${incident.priority}</span>
                </div>
                <p class="text-gray-400">Location: ${incident.locationName}</p>
                <p class="text-gray-400 text-sm mt-1">Units Dispatched: ${incident.unitsDispatched.join(', ')}</p>
            `;
            return card;
        }

        function renderFireStationCard(station) {
            const card = document.createElement('div');
            card.classList.add('card', 'bg-gray-800', 'p-6', 'rounded-lg', 'shadow-md');
            card.innerHTML = `
                <h4 class="text-xl font-bold">${station.stationName}</h4>
                <p class="text-gray-400 text-sm">Status: <span class="text-green-400">${station.status}</span></p>
                <div class="mt-4">
                    <p class="text-sm font-semibold">Apparatus Available:</p>
                    <ul class="list-disc list-inside text-gray-400 text-sm mt-1">
                        ${station.apparatus.map(app => `<li>${app.type} (${app.status})</li>`).join('')}
                    </ul>
                </div>
            `;
            return card;
        }

        // Dashboard Rendering Functions
        function renderEmsDashboard() {
            let filteredCards = [...emsData];
            if (currentFilter !== 'all') {
                filteredCards = filteredCards.filter(hospital => 
                    hospital.specialties[currentFilter] && hospital.specialties[currentFilter] !== 'Unavailable'
                );
            }
            filteredCards.sort((a, b) => {
                const statusOrder = { 'Accepting': 1, 'Capacity Alert': 2, 'Diversion': 3, 'Closed': 4 };
                const aStatus = statusOrder[a.status] || 5;
                const bStatus = statusOrder[b.status] || 5;
                if (aStatus !== bStatus) return aStatus - bStatus;
                return a.waitTime - b.waitTime;
            });
            emsContainer.innerHTML = '';
            filteredCards.forEach(hospital => {
                emsContainer.appendChild(renderHospitalCard(hospital));
            });
        }

        function renderPoliceDashboard() {
            policeUnitsContainer.innerHTML = '';
            policeData.units.forEach(unit => {
                policeUnitsContainer.appendChild(renderPoliceUnitCard(unit));
            });
            policeIncidentsContainer.innerHTML = '';
            policeData.incidents.forEach(incident => {
                policeIncidentsContainer.appendChild(renderPoliceIncidentCard(incident));
            });
        }

        function renderFireDashboard() {
            fireStationsContainer.innerHTML = '';
            fireData.forEach(station => {
                fireStationsContainer.appendChild(renderFireStationCard(station));
            });
        }

        // Map rendering
        function updateMap() {
            unitMarkers.clearLayers();
            incidentMarkers.clearLayers();
            
            policeData.units.forEach(unit => {
                const marker = L.marker(unit.location, { icon: policeIcon }).addTo(unitMarkers);
                marker.bindPopup(`<b>Unit: ${unit.unitId}</b><br>Status: ${unit.status}<br>Location: ${unit.locationName}`);
            });
            
            fireData.forEach(station => {
                station.apparatus.forEach(app => {
                    if (app.status === 'Available') {
                        const marker = L.marker(station.location, { icon: fireIcon }).addTo(unitMarkers);
                        marker.bindPopup(`<b>${app.type}</b><br>Station: ${station.stationName}<br>Status: ${app.status}`);
                    }
                });
            });

            emsData.forEach(hospital => {
                const marker = L.marker(hospital.location, { icon: emsIcon }).addTo(unitMarkers);
                marker.bindPopup(`<b>Hospital: ${hospital.name}</b><br>Status: ${hospital.status}<br>Wait Time: ${hospital.waitTime} min`);
            });

            policeData.incidents.forEach(incident => {
                const marker = L.marker(incident.location, { icon: incidentIcon }).addTo(incidentMarkers);
                marker.bindPopup(`<b>Incident: ${incident.callType}</b><br>Priority: ${incident.priority}<br>Location: ${incident.locationName}`);
            });
        }


        // API Simulation Functions (to be replaced with actual API calls)
        async function fetchEmsData() {
            // Check if it's time to change the trend direction
            if (erWaitTimeTrendCounter >= trendMax) {
                erWaitTimeTrendDirection *= -1;
                erWaitTimeTrendCounter = 0;
            }
            erWaitTimeTrendCounter++;

            // Update the data based on the trend
            const updatedData = emsData.map(hospital => {
                // Apply a subtle, trending change
                const waitTimeChange = erWaitTimeTrendDirection * (Math.random() * 1.5);
                const capacityChange = -erWaitTimeTrendDirection * (Math.random() * 1.5);
                
                const newWaitTime = Math.max(10, Math.min(60, hospital.waitTime + waitTimeChange));
                const newCapacity = Math.max(50, Math.min(100, hospital.erCapacity + capacityChange));
                
                return {
                    ...hospital,
                    waitTime: parseFloat(newWaitTime.toFixed(1)),
                    erCapacity: parseFloat(newCapacity.toFixed(1))
                };
            });
            return { hospitals: updatedData, lastUpdated: new Date().toLocaleTimeString() };
        }

        async function fetchPoliceData() {
            const mockUnits = [
                { unitId: 'P-101', status: 'Available', location: [39.2891, -76.6094], locationName: 'Downtown Baltimore' },
                { unitId: 'P-102', status: 'On Scene', location: [39.2748, -76.6094], locationName: 'Federal Hill' },
                { unitId: 'P-103', status: 'Available', location: [39.2880, -76.6015], locationName: 'Inner Harbor' },
                { unitId: 'P-104', status: 'On Patrol', location: [39.2818, -76.5926], locationName: 'Fells Point' },
                { unitId: 'P-105', status: 'Available', location: [39.2982, -76.6111], locationName: 'Mount Vernon' },
                { unitId: 'P-106', status: 'On Patrol', location: [39.2846, -76.5779], locationName: 'Canton' }
            ];
            const mockIncidents = [
                { incidentId: '2025-001A', callType: 'Motor Vehicle Accident', priority: 'High', location: [39.2892, -76.6212], locationName: 'Lombard St & Eutaw St', unitsDispatched: ['P-102'] },
                { incidentId: '2025-002B', callType: 'Assault Report', priority: 'Medium', location: [39.2789, -76.6062], locationName: 'Light St & Key Hwy', unitsDispatched: ['P-104'] }
            ];
            return { units: mockUnits, incidents: mockIncidents, lastUpdated: new Date().toLocaleTimeString() };
        }

        async function fetchFireData() {
            const mockStations = [
                { stationId: 'FS-1', stationName: 'Baltimore Fire Station 1', location: [39.2878, -76.6046], status: 'Normal', apparatus: [{ type: 'Engine 1', status: 'Available' }, { type: 'Ladder 1', status: 'Available' }, { type: 'Medic 1', status: 'Available' }] },
                { stationId: 'FS-2', stationName: 'Baltimore Fire Station 2', location: [39.2941, -76.6115], status: 'Active Call', apparatus: [{ type: 'Engine 2', status: 'Dispatched' }, { type: 'Ladder 2', status: 'Available' }, { type: 'Medic 2', status: 'Dispatched' }] },
                { stationId: 'FS-3', stationName: 'Baltimore Fire Station 3', location: [39.2829, -76.5779], status: 'Normal', apparatus: [{ type: 'Engine 3', status: 'Available' }, { type: 'Ladder 3', status: 'Available' }, { type: 'Medic 3', status: 'Available' }] }
            ];
            return { stations: mockStations, lastUpdated: new Date().toLocaleTimeString() };
        }

        async function updateDashboardData() {
            try {
                const emsResponse = await fetchEmsData();
                emsData = emsResponse.hospitals;
                document.getElementById('ems-last-updated').textContent = `Last updated: ${emsResponse.lastUpdated}`;
                renderEmsDashboard();
                updateEmsCharts();
                
                const policeResponse = await fetchPoliceData();
                policeData = policeResponse;
                document.getElementById('police-last-updated').textContent = `Last updated: ${policeResponse.lastUpdated}`;
                renderPoliceDashboard();
                trackIncidents();
                updatePoliceCharts();

                const fireResponse = await fetchFireData();
                fireData = fireResponse.stations;
                document.getElementById('fire-last-updated').textContent = `Last updated: ${fireResponse.lastUpdated}`;
                renderFireDashboard();
                updateFireCharts();
                
                updateMap();

            } catch (error) {
                console.error('Failed to fetch data:', error);
                document.getElementById('ems-last-updated').textContent = 'Last updated: Data fetch failed';
                document.getElementById('police-last-updated').textContent = 'Last updated: Data fetch failed';
                document.getElementById('fire-last-updated').textContent = 'Last updated: Data fetch failed';
            }
        }
        
        function trackIncidents() {
            const currentIncidentCount = policeData.incidents.length;
            if (currentIncidentCount > lastIncidentCheckCount) {
                incidentCount += (currentIncidentCount - lastIncidentCheckCount);
                hourlyIncidentCountDisplay.textContent = incidentCount;
            }
            lastIncidentCheckCount = currentIncidentCount;
        }

        function resetHourlyCount() {
            incidentCount = 0;
            hourlyIncidentCountDisplay.textContent = incidentCount;
            lastIncidentCheckCount = 0;
            console.log('Hourly incident count has been reset.');
        }

        // Modal Logic
        function showModal(data, service) {
            modalTitle.textContent = data.name || data.callType || data.stationName || '';
            let content = '';
            if (service === 'ems') {
                const specialtyDetails = Object.entries(data.specialties).map(([name, status]) => {
                    return `<li>${name.charAt(0).toUpperCase() + name.slice(1)}: <span class="text-white">${status}</span></li>`;
                }).join('');
                content = `
                    <p class="text-gray-300 mb-4">${data.notes}</p>
                    <div class="space-y-2">
                        <p><strong>Status:</strong> <span class="text-white">${data.status}</span></p>
                        <p><strong>Wait Time:</strong> <span class="text-white">${data.waitTime} min</span></p>
                        <p><strong>ER Capacity:</strong> <span class="text-white">${data.erCapacity}%</span></p>
                        <p><strong>Distance:</strong> <span class="text-white">${data.distance} miles</span></p>
                        <p><strong>ETA:</strong> <span class="text-white">${data.eta} min</span></p>
                    </div>
                    <div class="mt-4">
                        <h4 class="font-semibold text-lg text-white mb-2">Specialty Status:</h4>
                        <ul class="space-y-1 text-gray-400">
                            ${specialtyDetails}
                        </ul>
                    </div>
                `;
            } else if (service === 'police') {
                content = `
                    <p class="text-gray-300 mb-4">Location: ${data.locationName}</p>
                    <p><strong>Call Type:</strong> <span class="text-white">${data.callType}</span></p>
                    <p><strong>Priority:</strong> <span class="text-white">${data.priority}</span></p>
                    <p><strong>Units Dispatched:</strong> <span class="text-white">${data.unitsDispatched.join(', ')}</span></p>
                `;
            } else if (service === 'fire') {
                const apparatusList = data.apparatus.map(app => `<li>${app.type} (${app.status})</li>`).join('');
                content = `
                    <p><strong>Status:</strong> <span class="text-white">${data.status}</span></p>
                    <div class="mt-4">
                        <h4 class="font-semibold text-lg text-white mb-2">Apparatus:</h4>
                        <ul class="list-disc list-inside text-gray-400">
                            ${apparatusList}
                        </ul>
                    </div>
                `;
            }
            modalContent.innerHTML = content;
            modal.classList.remove('hidden');
        }

        closeModalBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
        });

        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.add('hidden');
            }
        });

        // Event listeners for filter buttons
        filterButtons.forEach(button => {
            button.addEventListener('click', () => {
                filterButtons.forEach(btn => {
                    btn.classList.remove('active', 'bg-blue-600', 'text-white');
                    btn.classList.add('bg-gray-700', 'text-gray-300');
                });
                button.classList.add('active', 'bg-blue-600', 'text-white');
                button.classList.remove('bg-gray-700', 'text-gray-300');
                currentFilter = button.dataset.filter;
                renderEmsDashboard();
            });
        });

        // Initial setup
        initializeCharts();
        showDashboard('main');
        updateDashboardData();
        setInterval(updateDashboardData, 30000); // Update every 30 seconds

        const now = new Date();
        const startOfNextHour = new Date(now.getFullYear(), now.getMonth(), now.getDate(), now.getHours() + 1, 0, 0);
        const timeUntilNextHour = startOfNextHour.getTime() - now.getTime();

        setTimeout(() => {
            resetHourlyCount();
            setInterval(resetHourlyCount, 60 * 60 * 1000);
        }, timeUntilNextHour);

    </script>
</body>
</html>